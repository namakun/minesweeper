<!DOCTYPE html>
<html>
  <head>
    <link rel="icon" type="image/png" href="./favicon.png" sizes="48x48" />
    <meta charset="UTF-8" />
    <title>Minesweeper</title>
    <style>
      body {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 500px; /* ‰æã: 500px„Å´Ë®≠ÂÆö */
        background-color: black;
      }

      .container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: white;
      }

      h1 {
        color: white;
      }

      #restartButton {
        font-size: 18px;
        padding: 10px 20px;
        margin-bottom: 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        background-color: #4caf50;
        color: white;
      }

      #game {
        width: 270px;
        height: 270px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        background-color: #dfdfdf;
        margin: 20px 0;
      }

      #gameOver,
      #gameClear {
        font-size: 24px;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        visibility: hidden;
      }

      #gameOver {
        color: red;
      }

      #gameClear {
        color: green;
      }

      .cell {
        display: inline-flex;
        justify-content: center;
        align-items: center;
        box-sizing: border-box;
        width: 30px;
        height: 30px;
        border: 1px solid #909090;
        font-size: 28px;
        background-color: #dfdfdf;
        color: #fff;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Minesweeper Game</h1>
      <button id="restartButton">Restart Game</button>
      <div id="game"></div>
    </div>
    <div id="gameOver">Game Over!</div>
    <div id="gameClear">Game Clear!</div>

    <script type="module">
      import init, { Board } from "./minesweeper.js";

      let board;
      let firstClick = true;
      let gameOver = false;

      document.getElementById("restartButton").addEventListener("click", restartGame);

      async function run() {
        await init();
        restartGame();
      }

      function restartGame() {
        board = Board.new(9, 9);
        firstClick = true;
        gameOver = false;
        updateUI(board);
        const gameOverMessage = document.getElementById("gameOver");
        gameOverMessage.style.visibility = "hidden";
        const gameClearMessage = document.getElementById("gameClear");
        gameClearMessage.style.visibility = "hidden";
      }

      function updateUI(board) {
        const gameContainer = document.getElementById("game");
        gameContainer.innerHTML = "";

        for (let y = 0; y < 9; y++) {
          const rowDiv = document.createElement("div");
          rowDiv.style.display = "flex";

          for (let x = 0; x < 9; x++) {
            const cellDiv = document.createElement("div");
            cellDiv.classList.add("cell");

            cellDiv.addEventListener("click", (e) => {
              e.preventDefault();
              if (gameOver || board.get_cell_state(x, y).is_flagged) return;
              if (!board.get_cell_state(x, y).is_open) {
                handleCellClick(board, x, y, cellDiv);
              }
            });

            cellDiv.addEventListener("contextmenu", (e) => {
              e.preventDefault();
              if (gameOver) return;
              if (!board.get_cell_state(x, y).is_open) {
                board.toggle_flag(x, y);
                handleFlagToggle(cellDiv, board.get_cell_state(x, y));
              }
            });

            rowDiv.appendChild(cellDiv);
          }
          gameContainer.appendChild(rowDiv);
        }
      }
      function updateCellUI(x, y) {
        const cellState = board.get_cell_state(x, y);
        const cellDiv = document.querySelector(`#game div:nth-child(${y + 1}) div:nth-child(${x + 1})`);

        if (cellState.is_open) {
          const minesAround = board.count_mines_around(x, y);
          cellDiv.textContent = minesAround > 0 ? minesAround : "";
          cellDiv.style.backgroundColor = "#bfbfbf";

          switch (minesAround) {
            case 1:
              cellDiv.style.color = "blue";
              break;
            case 2:
              cellDiv.style.color = "green";
              break;
            case 3:
              cellDiv.style.color = "red";
              break;
            case 4:
              cellDiv.style.color = "purple";
              break;
            default:
              cellDiv.style.color = "black";
          }
        }

        // Êóó„ÅåÁ´ã„Å£„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅÆÂá¶ÁêÜ„ÇÇ„Åì„Åì„Å´ËøΩÂä†
        // ...
      }

      function handleFlagToggle(cellDiv, cellState) {
        if (cellState.is_flagged) {
          cellDiv.textContent = "üö©"; // Êóó„ÇíË°®Á§∫
        } else {
          cellDiv.textContent = cellState.is_open ? cellState.mines_around.toString() : "";
        }
      }

      function handleCellClick(board, x, y, cellDiv) {
        const changedCells = board.open_cell(x, y);
        changedCells.forEach((cell) => {
          updateCellUI(cell.x, cell.y);
        });

        if (board.is_game_over()) {
          gameOver = true;
          revealMines(board);
          const gameOverMessage = document.getElementById("gameOver");
          gameOverMessage.style.visibility = "visible";
        }

        if (!gameOver && board.check_win()) {
          const gameClearMessage = document.getElementById("gameClear");
          gameClearMessage.style.visibility = "visible";
        }
      }

      function revealMines(board) {
        for (let y = 0; y < 9; y++) {
          for (let x = 0; x < 9; x++) {
            const cell = document.querySelector(`#game div:nth-child(${y + 1}) div:nth-child(${x + 1})`);
            if (board.get_cell_state(x, y).is_mine) {
              cell.textContent = "üí£";
            }
          }
        }
      }

      run();
    </script>
  </body>
</html>
