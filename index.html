<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Minesweeper</title>
    <style>
      /* ç”»é¢å…¨ä½“ã®ã‚¹ã‚¿ã‚¤ãƒ« */
      body {
        height: 50vh; /* é«˜ã•ã‚’50vhã«èª¿æ•´ */
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        background-color: black; /* èƒŒæ™¯ã‚’é»’ã« */
      }
      /* ã‚¿ã‚¤ãƒˆãƒ«ã®ã‚¹ã‚¿ã‚¤ãƒ« */
      h1 {
        color: white;
        margin-bottom: 20px;
      }
      /* ãƒã‚¤ãƒ³ã‚¹ã‚¤ãƒ¼ãƒ‘ãƒ¼ã®ã‚²ãƒ¼ãƒ ã‚¨ãƒªã‚¢ */
      #game {
        display: flex;
        flex-direction: column;
        justify-content: center;
        background-color: #dfdfdf;
      }

      /* å„ã‚»ãƒ«ã®ã‚¹ã‚¿ã‚¤ãƒ« */
      .cell {
        display: inline-flex;
        justify-content: center;
        align-items: center;
        box-sizing: border-box;
        box-sizing: border-box;
        width: 30px;
        height: 30px;
        border: 1px solid #909090;
        font-size: 28px;
        background-color: #dfdfdf; /* ã‚»ãƒ«ã®èƒŒæ™¯è‰²ã‚’ç°è‰²ã« */
        color: #fff; /* ã‚»ãƒ«ã®æ–‡å­—è‰²ã‚’ç™½ã« */
      }
    </style>
  </head>
  <body>
    <h1>Minesweeper Game</h1>
    <button id="restartButton">Restart Game</button>
    <div id="game"></div>
    <div id="gameOverMessage" style="visibility: hidden; color: red; font-size: 24px; position: absolute; top: 55%; left: 50%; transform: translate(-50%, -50%)">Game Over!</div>
    <div id="gameClearMessage" style="visibility: hidden; color: green; font-size: 24px; position: absolute; top: 55%; left: 50%; transform: translate(-50%, -50%)">Game Clear!</div>

    <script type="module">
      import init, { Board } from "./pkg/minesweeper.js";

      let board;
      let firstClick = true; // æœ€åˆã®ã‚¯ãƒªãƒƒã‚¯ã‚’è¿½è·¡ã™ã‚‹ãƒ•ãƒ©ã‚°
      let gameOver = false; // ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼çŠ¶æ…‹ã‚’è¿½è·¡

      document.getElementById("restartButton").addEventListener("click", restartGame);

      async function run() {
        await init(); // WASMãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®åˆæœŸåŒ–
        restartGame(); // åˆæœŸãƒ­ãƒ¼ãƒ‰æ™‚ã«ã‚‚ã‚²ãƒ¼ãƒ ã‚’ãƒªã‚¹ã‚¿ãƒ¼ãƒˆ
      }

      function restartGame() {
        board = Board.new(9, 9); // æ–°ã—ã„ãƒœãƒ¼ãƒ‰ã‚’ç”Ÿæˆ
        firstClick = true;
        gameOver = false;
        updateUI(board);
      }

      function updateUI(board) {
        // updateUIé–¢æ•°å†…ã§ã®ã‚»ãƒ«çŠ¶æ…‹ã®ç¢ºèª
        const gameContainer = document.getElementById("game");
        gameContainer.innerHTML = "";

        for (let y = 0; y < 9; y++) {
          const rowDiv = document.createElement("div");
          rowDiv.style.display = "flex";

          for (let x = 0; x < 9; x++) {
            const cellDiv = document.createElement("div");
            cellDiv.classList.add("cell");

            // ã‚»ãƒ«ã‚’å·¦ã‚¯ãƒªãƒƒã‚¯ã—ãŸã¨ãã®ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©
            cellDiv.addEventListener("click", (e) => {
              e.preventDefault();
              if (gameOver || board.get_cell_state(x, y).is_flagged) return; // ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ã¾ãŸã¯æ——ãŒç«‹ã£ã¦ã„ã‚‹ã‚»ãƒ«ã¯æ“ä½œä¸å¯
              if (!board.get_cell_state(x, y).is_open) {
                // ã‚»ãƒ«ãŒæ—¢ã«é–‹ã„ã¦ã„ãªã„å ´åˆã«ã®ã¿å‡¦ç†
                handleCellClick(board, x, y, cellDiv);
              }
            });

            // ã‚»ãƒ«ã‚’å³ã‚¯ãƒªãƒƒã‚¯ã—ãŸã¨ãã®ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©
            cellDiv.addEventListener("contextmenu", (e) => {
              e.preventDefault(); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é˜²æ­¢
              if (gameOver) return; // ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼æ™‚ã¯æ“ä½œä¸å¯
              if (!board.get_cell_state(x, y).is_open) {
                // ã‚»ãƒ«ãŒæ—¢ã«é–‹ã„ã¦ã„ãªã„å ´åˆã«ã®ã¿æ——ã‚’åˆ‡ã‚Šæ›¿ãˆ
                board.toggle_flag(x, y);
                handleFlagToggle(cellDiv, board.get_cell_state(x, y));
              }
            });

            rowDiv.appendChild(cellDiv);
          }
          gameContainer.appendChild(rowDiv);
        }
      }
      function updateCellUI(x, y) {
        const cellState = board.get_cell_state(x, y);
        const cellDiv = document.querySelector(`#game div:nth-child(${y + 1}) div:nth-child(${x + 1})`);

        // ã‚»ãƒ«ã®çŠ¶æ…‹ãŒé–‹ã„ã¦ã„ã‚‹å ´åˆã€èƒŒæ™¯è‰²ã¨ãƒ†ã‚­ã‚¹ãƒˆã‚’æ›´æ–°
        if (cellState.is_open) {
          const minesAround = board.count_mines_around(x, y);
          cellDiv.textContent = minesAround > 0 ? minesAround : "";
          cellDiv.style.backgroundColor = "#bfbfbf";
        }

        // æ——ãŒç«‹ã£ã¦ã„ã‚‹å ´åˆã®å‡¦ç†ã‚‚ã“ã“ã«è¿½åŠ 
        // ...
      }

      function handleFlagToggle(cellDiv, cellState) {
        if (cellState.is_flagged) {
          cellDiv.textContent = "ğŸš©"; // æ——ã‚’è¡¨ç¤º
        } else {
          // æ——ãŒå–ã‚Šé™¤ã‹ã‚ŒãŸå ´åˆã€ã‚»ãƒ«ãŒé–‹ã„ã¦ã„ã‚Œã°å‘¨å›²ã®åœ°é›·æ•°ã‚’è¡¨ç¤ºï¼ˆé–‹ã„ã¦ã„ãªã‘ã‚Œã°ä½•ã‚‚è¡¨ç¤ºã—ãªã„ï¼‰
          cellDiv.textContent = cellState.is_open ? cellState.mines_around.toString() : "";
        }
      }

      function handleCellClick(board, x, y, cellDiv) {
        const changedCells = board.open_cell(x, y);
        changedCells.forEach((cell) => {
          updateCellUI(cell.x, cell.y); // `updateCellUI`ã¯ã‚»ãƒ«ã®UIã‚’æ›´æ–°ã™ã‚‹JavaScripté–¢æ•°
        });

        if (board.is_game_over()) {
          gameOver = true; // ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼çŠ¶æ…‹ã‚’æ›´æ–°
          revealMines(board); // ã™ã¹ã¦ã®åœ°é›·ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°ã‚’å‘¼ã³å‡ºã™
          const gameOverMessage = document.getElementById("gameOverMessage");
          gameOverMessage.style.visibility = "visible"; // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
        }

        if (!gameOver && board.check_win()) {
          // ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ã§ãªã„ã€ã‹ã¤å‹åˆ©æ¡ä»¶ã‚’æº€ãŸã™å ´åˆ
          // ã‚²ãƒ¼ãƒ ã‚¯ãƒªã‚¢ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯ã‚’ã“ã“ã«è¿½åŠ 
          const gameClearMessage = document.getElementById("gameClearMessage");
          gameClearMessage.style.visibility = "visible"; // ã‚²ãƒ¼ãƒ ã‚¯ãƒªã‚¢ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
        }
      }

      function revealMines(board) {
        // ã™ã¹ã¦ã®ã‚»ãƒ«ã‚’èµ°æŸ»ã—ã¦åœ°é›·ã‚’è¡¨ç¤º
        for (let y = 0; y < 9; y++) {
          for (let x = 0; x < 9; x++) {
            const cell = document.querySelector(`#game div:nth-child(${y + 1}) div:nth-child(${x + 1})`);
            if (board.get_cell_state(x, y).is_mine) {
              cell.textContent = "ğŸ’£";
            }
          }
        }
      }

      run();
    </script>
  </body>
</html>
